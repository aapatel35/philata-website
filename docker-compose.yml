version: '3.8'

services:
  # Philata Flask Website
  philata-web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: philata-web
    restart: unless-stopped
    ports:
      - "5001:5001"
    environment:
      - FLASK_ENV=production
      - FLASK_APP=app.py
    networks:
      - philata-network
    volumes:
      - ./static:/app/static
      - ./templates:/app/templates

  # MongoDB Database for IELTS Platform
  mongodb:
    image: mongo:7.0
    container_name: ielts-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    environment:
      - MONGO_INITDB_DATABASE=ielts-platform
    networks:
      - philata-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # IELTS Platform Backend API
  ielts-backend:
    build:
      context: ./ielts-platform/backend
      dockerfile: Dockerfile
    container_name: ielts-backend
    restart: unless-stopped
    ports:
      - "5000:5000"
    environment:
      - NODE_ENV=production
      - PORT=5000
      - MONGODB_URI=mongodb://mongodb:27017/ielts-platform
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - FRONTEND_URL=http://localhost:3000
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - philata-network

  # IELTS Platform Frontend
  ielts-frontend:
    build:
      context: ./ielts-platform/frontend
      dockerfile: Dockerfile
    container_name: ielts-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_API_URL=http://localhost:5000/api
    depends_on:
      - ielts-backend
    networks:
      - philata-network

  # Social Media Automation
  social-automation:
    build:
      context: ./social-automation
      dockerfile: Dockerfile
    container_name: philata-social-automation
    restart: "no"
    environment:
      - CLOUDINARY_CLOUD_NAME=${CLOUDINARY_CLOUD_NAME}
      - CLOUDINARY_API_KEY=${CLOUDINARY_API_KEY}
      - CLOUDINARY_API_SECRET=${CLOUDINARY_API_SECRET}
      - FB_PAGE_ID=${FB_PAGE_ID}
      - IG_BUSINESS_ID=${IG_BUSINESS_ID}
      - FB_ACCESS_TOKEN=${FB_ACCESS_TOKEN}
      - X_API_KEY=${X_API_KEY}
      - X_API_SECRET=${X_API_SECRET}
      - X_ACCESS_TOKEN=${X_ACCESS_TOKEN}
      - X_ACCESS_TOKEN_SECRET=${X_ACCESS_TOKEN_SECRET}
      - LINKEDIN_WEBHOOK_URL=${LINKEDIN_WEBHOOK_URL}
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
    volumes:
      - ./social-automation:/app
      - ./generated_content:/app/generated_content
    networks:
      - philata-network

  # Mongo Express (Database Admin UI)
  mongo-express:
    image: mongo-express:latest
    container_name: philata-mongo-express
    restart: unless-stopped
    ports:
      - "8081:8081"
    environment:
      - ME_CONFIG_MONGODB_SERVER=mongodb
      - ME_CONFIG_MONGODB_PORT=27017
      - ME_CONFIG_BASICAUTH_USERNAME=admin
      - ME_CONFIG_BASICAUTH_PASSWORD=admin123
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - philata-network

networks:
  philata-network:
    driver: bridge

volumes:
  mongodb_data:
    driver: local
