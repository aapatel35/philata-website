{% extends "base.html" %}

{% block title %}CRS Score Prediction - Express Entry Forecast{% endblock %}

{% block extra_css %}
<style>
    .page-header-prediction {
        margin-bottom: 32px;
    }

    .page-header-prediction .page-title {
        font-family: 'Plus Jakarta Sans', var(--font-family);
        font-size: 32px;
        font-weight: 800;
        color: var(--text);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 14px;
    }

    .page-header-prediction .page-title i {
        font-size: 28px;
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .page-subtitle {
        color: var(--text-muted);
        font-size: 1rem;
    }

    /* Next Draw Prediction Card */
    .next-draw-card {
        background: linear-gradient(135deg, #1E3A5F 0%, #0891B2 100%);
        border-radius: 24px;
        padding: 2.5rem;
        color: white;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }

    .next-draw-card::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 60%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    }

    .next-draw-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 1.5rem;
        position: relative;
        z-index: 1;
    }

    .next-draw-header i {
        font-size: 2rem;
        opacity: 0.9;
    }

    .next-draw-header h2 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
    }

    .next-draw-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 1.5rem;
        position: relative;
        z-index: 1;
    }

    .draw-stat {
        text-align: center;
        padding: 1.5rem 1rem;
        background: rgba(255,255,255,0.1);
        border-radius: 16px;
        backdrop-filter: blur(10px);
    }

    .draw-stat-value {
        font-size: 2rem;
        font-weight: 800;
        line-height: 1;
        margin-bottom: 0.5rem;
    }

    .draw-stat-label {
        font-size: 0.8rem;
        opacity: 0.9;
    }

    /* Prediction Details Grid */
    .prediction-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .prediction-card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 1.5rem;
    }

    .prediction-card-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border);
    }

    .prediction-card-header i {
        font-size: 1.25rem;
        color: var(--primary);
    }

    .prediction-card-header h3 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text);
    }

    .prediction-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--border);
    }

    .prediction-item:last-child {
        border-bottom: none;
    }

    .prediction-item-label {
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    .prediction-item-value {
        font-weight: 600;
        color: var(--text);
    }

    .prediction-item-value.highlight {
        color: var(--primary);
        font-size: 1.1rem;
    }

    /* Category Predictions */
    .category-predictions {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .category-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 1.5rem;
    }

    .category-header i {
        font-size: 1.5rem;
        color: var(--accent);
    }

    .category-header h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text);
    }

    .category-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .category-item {
        background: var(--bg);
        border-radius: 12px;
        padding: 1.25rem;
        text-align: center;
        border: 1px solid var(--border);
    }

    .category-name {
        font-weight: 600;
        color: var(--text);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .category-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
    }

    .category-badge.likely {
        background: rgba(16, 185, 129, 0.15);
        color: #059669;
    }

    .category-badge.possible {
        background: rgba(245, 158, 11, 0.15);
        color: #D97706;
    }

    .category-score {
        font-size: 1.75rem;
        font-weight: 800;
        color: var(--primary);
        margin-bottom: 0.25rem;
    }

    .category-label {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    /* Recent Draws Table */
    .draws-section {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        overflow: hidden;
        margin-bottom: 2rem;
    }

    .draws-header {
        background: var(--bg);
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .draws-header i {
        font-size: 1.25rem;
        color: var(--accent);
    }

    .draws-header h3 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text);
    }

    .draws-table {
        width: 100%;
    }

    .draw-row {
        display: grid;
        grid-template-columns: 1.2fr 1fr 0.8fr 0.8fr;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border);
        align-items: center;
    }

    .draw-row:last-child {
        border-bottom: none;
    }

    .draw-row.header {
        background: var(--bg);
        font-weight: 600;
        color: var(--text-muted);
        font-size: 0.8rem;
        text-transform: uppercase;
    }

    .draw-row:not(.header):hover {
        background: rgba(30, 58, 138, 0.03);
    }

    .draw-crs {
        font-weight: 700;
        font-size: 1.1rem;
        color: var(--primary);
    }

    .draw-category-badge {
        display: inline-flex;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .draw-category-badge.general {
        background: rgba(99, 102, 241, 0.15);
        color: #6366F1;
    }

    .draw-category-badge.healthcare {
        background: rgba(16, 185, 129, 0.15);
        color: #059669;
    }

    .draw-category-badge.french {
        background: rgba(59, 130, 246, 0.15);
        color: #3B82F6;
    }

    .draw-category-badge.stem {
        background: rgba(168, 85, 247, 0.15);
        color: #A855F7;
    }

    .draw-category-badge.trade {
        background: rgba(245, 158, 11, 0.15);
        color: #D97706;
    }

    /* Reasoning Section */
    .reasoning-section {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .reasoning-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 1.5rem;
    }

    .reasoning-header i {
        font-size: 1.5rem;
        color: var(--primary);
    }

    .reasoning-header h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text);
    }

    .reasoning-item {
        padding: 1rem;
        background: var(--bg);
        border-radius: 12px;
        margin-bottom: 1rem;
        border-left: 4px solid var(--primary);
    }

    .reasoning-item:last-child {
        margin-bottom: 0;
    }

    .reasoning-title {
        font-weight: 600;
        color: var(--text);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .reasoning-title i {
        color: var(--primary);
        font-size: 1rem;
    }

    .reasoning-text {
        color: var(--text-muted);
        font-size: 0.9rem;
        line-height: 1.6;
    }

    /* Score Check Section */
    .score-check-section {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
        border: 1px solid rgba(99, 102, 241, 0.3);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        text-align: center;
    }

    .score-check-section h3 {
        margin: 0 0 1rem 0;
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text);
    }

    .score-check-section p {
        color: var(--text-muted);
        margin-bottom: 1.5rem;
    }

    .score-check-form {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
    }

    .score-input {
        padding: 0.875rem 1.25rem;
        font-size: 1.25rem;
        font-weight: 600;
        text-align: center;
        background: var(--card);
        border: 2px solid var(--border);
        border-radius: 12px;
        color: var(--text);
        width: 150px;
    }

    .score-input:focus {
        outline: none;
        border-color: var(--primary);
    }

    .check-btn {
        padding: 0.875rem 2rem;
        font-size: 1rem;
        font-weight: 600;
        background: var(--gradient-primary);
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .check-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(30, 58, 95, 0.3);
    }

    /* Check Result */
    .check-result {
        display: none;
        margin-top: 1.5rem;
        padding: 1.5rem;
        background: var(--card);
        border-radius: 12px;
        text-align: left;
    }

    .check-result.show {
        display: block;
    }

    .result-status {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 1rem;
    }

    .result-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .result-icon.excellent {
        background: rgba(16, 185, 129, 0.15);
        color: #059669;
    }

    .result-icon.good {
        background: rgba(52, 211, 153, 0.15);
        color: #10B981;
    }

    .result-icon.moderate {
        background: rgba(245, 158, 11, 0.15);
        color: #D97706;
    }

    .result-icon.low {
        background: rgba(239, 68, 68, 0.15);
        color: #DC2626;
    }

    .result-text h4 {
        margin: 0 0 4px 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text);
    }

    .result-text p {
        margin: 0;
        font-size: 0.9rem;
        color: var(--text-muted);
    }

    .result-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border);
    }

    .result-detail {
        text-align: center;
    }

    .result-detail-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary);
    }

    .result-detail-label {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    /* Disclaimer */
    .disclaimer-box {
        background: rgba(245, 158, 11, 0.1);
        border: 1px solid rgba(245, 158, 11, 0.3);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        font-size: 0.9rem;
        color: var(--text);
    }

    .disclaimer-box i {
        color: #D97706;
        margin-right: 8px;
    }

    @media (max-width: 768px) {
        .next-draw-stats {
            grid-template-columns: repeat(2, 1fr);
        }

        .draw-row {
            grid-template-columns: 1fr;
            gap: 0.5rem;
            padding: 1rem;
        }

        .draw-row.header {
            display: none;
        }

        .category-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .score-check-form {
            flex-direction: column;
            align-items: center;
        }

        .score-input, .check-btn {
            width: 100%;
            max-width: 300px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header-prediction">
    <h1 class="page-title">
        <i class="bi bi-graph-up-arrow"></i>
        CRS Score Prediction
    </h1>
    <p class="page-subtitle">AI-powered Express Entry draw predictions based on historical IRCC data and trends</p>
</div>

<!-- Next Draw Prediction Card -->
<div class="next-draw-card">
    <div class="next-draw-header">
        <i class="bi bi-lightning-charge-fill"></i>
        <h2>Next Express Entry Draw Prediction</h2>
    </div>
    <div class="next-draw-stats">
        <div class="draw-stat">
            <div class="draw-stat-value" id="predictedCutoff">{{ avg_crs if avg_crs else 520 }}</div>
            <div class="draw-stat-label">Predicted CRS Cutoff</div>
        </div>
        <div class="draw-stat">
            <div class="draw-stat-value" id="predictedItas">2,800</div>
            <div class="draw-stat-label">Expected ITAs</div>
        </div>
        <div class="draw-stat">
            <div class="draw-stat-value" id="predictedDate">Jan 15</div>
            <div class="draw-stat-label">Expected Date</div>
        </div>
        <div class="draw-stat">
            <div class="draw-stat-value" id="predictedProgram">FSW/CEC</div>
            <div class="draw-stat-label">Target Programs</div>
        </div>
        <div class="draw-stat">
            <div class="draw-stat-value" id="predictedCategory">General</div>
            <div class="draw-stat-label">Draw Category</div>
        </div>
        <div class="draw-stat">
            <div class="draw-stat-value" id="drawFrequency">Bi-weekly</div>
            <div class="draw-stat-label">Draw Frequency</div>
        </div>
    </div>
</div>

<!-- Prediction Details Grid -->
<div class="prediction-grid">
    <div class="prediction-card">
        <div class="prediction-card-header">
            <i class="bi bi-bar-chart-fill"></i>
            <h3>General Draw Analysis</h3>
        </div>
        <div class="prediction-item">
            <span class="prediction-item-label">Average CRS (Last 5 Draws)</span>
            <span class="prediction-item-value highlight" id="avgCrsDisplay">{{ avg_crs if avg_crs else 520 }}</span>
        </div>
        <div class="prediction-item">
            <span class="prediction-item-label">Highest Recent CRS</span>
            <span class="prediction-item-value" id="highestCrs">524</span>
        </div>
        <div class="prediction-item">
            <span class="prediction-item-label">Lowest Recent CRS</span>
            <span class="prediction-item-value" id="lowestCrs">518</span>
        </div>
        <div class="prediction-item">
            <span class="prediction-item-label">CRS Trend</span>
            <span class="prediction-item-value" style="color: #059669;">Stable</span>
        </div>
    </div>

    <div class="prediction-card">
        <div class="prediction-card-header">
            <i class="bi bi-people-fill"></i>
            <h3>ITA Distribution</h3>
        </div>
        <div class="prediction-item">
            <span class="prediction-item-label">Average ITAs per Draw</span>
            <span class="prediction-item-value highlight" id="avgItas">2,870</span>
        </div>
        <div class="prediction-item">
            <span class="prediction-item-label">Total ITAs (Last Month)</span>
            <span class="prediction-item-value" id="monthlyItas">~11,500</span>
        </div>
        <div class="prediction-item">
            <span class="prediction-item-label">2026 Target</span>
            <span class="prediction-item-value">110,770</span>
        </div>
        <div class="prediction-item">
            <span class="prediction-item-label">Pool Size (Est.)</span>
            <span class="prediction-item-value">~200,000</span>
        </div>
    </div>
</div>

<!-- Category-Based Draw Predictions -->
<div class="category-predictions">
    <div class="category-header">
        <i class="bi bi-diagram-3-fill"></i>
        <h3>Category-Based Draw Predictions</h3>
    </div>
    <div class="category-grid">
        <div class="category-item">
            <div class="category-name">
                General
                <span class="category-badge likely">Likely Next</span>
            </div>
            <div class="category-score">520</div>
            <div class="category-label">Predicted Cutoff</div>
        </div>
        <div class="category-item">
            <div class="category-name">
                Healthcare
                <span class="category-badge possible">Possible</span>
            </div>
            <div class="category-score">430</div>
            <div class="category-label">Predicted Cutoff</div>
        </div>
        <div class="category-item">
            <div class="category-name">
                STEM
                <span class="category-badge possible">Possible</span>
            </div>
            <div class="category-score">480</div>
            <div class="category-label">Predicted Cutoff</div>
        </div>
        <div class="category-item">
            <div class="category-name">
                French Proficiency
                <span class="category-badge possible">Possible</span>
            </div>
            <div class="category-score">380</div>
            <div class="category-label">Predicted Cutoff</div>
        </div>
        <div class="category-item">
            <div class="category-name">
                Trade Occupations
                <span class="category-badge possible">Possible</span>
            </div>
            <div class="category-score">420</div>
            <div class="category-label">Predicted Cutoff</div>
        </div>
        <div class="category-item">
            <div class="category-name">
                Transport
                <span class="category-badge possible">Possible</span>
            </div>
            <div class="category-score">440</div>
            <div class="category-label">Predicted Cutoff</div>
        </div>
    </div>
</div>

<!-- Check Your Score Section -->
<div class="score-check-section">
    <h3><i class="bi bi-person-check me-2"></i>Check Your ITA Chances</h3>
    <p>Enter your CRS score to see if you would qualify for the predicted draws</p>
    <div class="score-check-form">
        <input type="number" id="userScore" class="score-input" placeholder="Your CRS" min="0" max="1200">
        <button class="check-btn" onclick="checkScore()">
            <i class="bi bi-search"></i>
            Check Chances
        </button>
    </div>
    <div class="check-result" id="checkResult">
        <div class="result-status">
            <div class="result-icon" id="resultIcon">
                <i class="bi bi-check-circle-fill"></i>
            </div>
            <div class="result-text">
                <h4 id="resultTitle">Excellent Chances!</h4>
                <p id="resultDescription">Your score is above the predicted cutoff.</p>
            </div>
        </div>
        <div class="result-details">
            <div class="result-detail">
                <div class="result-detail-value" id="resultChance">95%</div>
                <div class="result-detail-label">ITA Probability</div>
            </div>
            <div class="result-detail">
                <div class="result-detail-value" id="resultDiff">+30</div>
                <div class="result-detail-label">Points Above Cutoff</div>
            </div>
            <div class="result-detail">
                <div class="result-detail-value" id="resultCategories">3</div>
                <div class="result-detail-label">Categories Eligible</div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Draws History -->
<div class="draws-section">
    <div class="draws-header">
        <i class="bi bi-clock-history"></i>
        <h3>Recent Express Entry Draws</h3>
    </div>
    <div class="draws-table">
        <div class="draw-row header">
            <span>Date</span>
            <span>Category</span>
            <span>CRS Cutoff</span>
            <span>ITAs Issued</span>
        </div>
        {% if draws %}
            {% for draw in draws %}
            <div class="draw-row">
                <span>{{ draw.date }}</span>
                <span>
                    <span class="draw-category-badge {% if 'general' in draw.category|lower or draw.category == 'No program specified' %}general{% elif 'health' in draw.category|lower %}healthcare{% elif 'french' in draw.category|lower %}french{% elif 'stem' in draw.category|lower %}stem{% elif 'trade' in draw.category|lower %}trade{% else %}general{% endif %}">
                        {{ draw.category if draw.category != 'No program specified' else 'General' }}
                    </span>
                </span>
                <span class="draw-crs">{{ draw.crs_score }}</span>
                <span>{{ draw.itas }}</span>
            </div>
            {% endfor %}
        {% else %}
            <div class="draw-row">
                <span>Jan 8, 2026</span>
                <span><span class="draw-category-badge general">General</span></span>
                <span class="draw-crs">524</span>
                <span>2,500</span>
            </div>
            <div class="draw-row">
                <span>Dec 19, 2025</span>
                <span><span class="draw-category-badge general">General</span></span>
                <span class="draw-crs">518</span>
                <span>3,200</span>
            </div>
            <div class="draw-row">
                <span>Dec 11, 2025</span>
                <span><span class="draw-category-badge healthcare">Healthcare</span></span>
                <span class="draw-crs">431</span>
                <span>1,800</span>
            </div>
            <div class="draw-row">
                <span>Dec 4, 2025</span>
                <span><span class="draw-category-badge french">French</span></span>
                <span class="draw-crs">379</span>
                <span>6,000</span>
            </div>
            <div class="draw-row">
                <span>Nov 27, 2025</span>
                <span><span class="draw-category-badge general">General</span></span>
                <span class="draw-crs">522</span>
                <span>2,850</span>
            </div>
        {% endif %}
    </div>
</div>

<!-- Reasoning Section -->
<div class="reasoning-section">
    <div class="reasoning-header">
        <i class="bi bi-lightbulb-fill"></i>
        <h3>Prediction Methodology & Reasoning</h3>
    </div>

    <div class="reasoning-item">
        <div class="reasoning-title">
            <i class="bi bi-graph-up"></i>
            Historical Trend Analysis
        </div>
        <div class="reasoning-text">
            Our predictions are based on the last 20+ Express Entry draws. General category cutoffs have averaged around {{ avg_crs if avg_crs else 520 }} points recently. The trend shows stable cutoffs with minor fluctuations based on pool composition and IRCC's immigration targets.
        </div>
    </div>

    <div class="reasoning-item">
        <div class="reasoning-title">
            <i class="bi bi-people"></i>
            Pool Size & Competition
        </div>
        <div class="reasoning-text">
            The Express Entry pool currently contains approximately 200,000+ candidates. Higher pool sizes typically lead to higher cutoff scores. IRCC aims to balance immigration targets with selecting highly qualified candidates. Category-based draws help candidates with lower CRS scores but specific qualifications.
        </div>
    </div>

    <div class="reasoning-item">
        <div class="reasoning-title">
            <i class="bi bi-calendar-check"></i>
            Draw Schedule Pattern
        </div>
        <div class="reasoning-text">
            IRCC conducts Express Entry draws approximately every 2 weeks. General draws and category-based draws (Healthcare, STEM, French, Trade, Transport, Agriculture) are scheduled alternately. The next general draw is typically expected within 7-14 days of the previous one.
        </div>
    </div>

    <div class="reasoning-item">
        <div class="reasoning-title">
            <i class="bi bi-flag"></i>
            Immigration Levels Plan 2024-2026
        </div>
        <div class="reasoning-text">
            Canada's Immigration Levels Plan targets 485,000 new permanent residents in 2024, with Express Entry accounting for a significant portion. This high target supports larger draw sizes. Category-based selection allows IRCC to prioritize specific occupations aligned with labor market needs.
        </div>
    </div>
</div>

<!-- Disclaimer -->
<div class="disclaimer-box">
    <i class="bi bi-exclamation-triangle-fill"></i>
    <strong>Disclaimer:</strong> Predictions are based on historical data and statistical analysis. Actual draw results may vary significantly. IRCC determines all Express Entry draw parameters. This tool is for informational purposes only and should not be relied upon for immigration decisions.
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize data
const draws = {{ draws | tojson | safe if draws else '[]' }};
const avgCrs = {{ avg_crs if avg_crs else 520 }};

// Calculate and display predictions on page load
document.addEventListener('DOMContentLoaded', function() {
    initializePredictions();
});

function initializePredictions() {
    // Calculate predicted cutoff from draws
    let predictedCutoff = avgCrs;
    let highestCrs = 0;
    let lowestCrs = 999;
    let totalItas = 0;

    if (draws && draws.length > 0) {
        const generalDraws = draws.filter(d =>
            d.category && (d.category.toLowerCase().includes('general') || d.category === 'No program specified')
        );

        if (generalDraws.length > 0) {
            let sum = 0;
            generalDraws.forEach(d => {
                sum += d.crs_score;
                if (d.crs_score > highestCrs) highestCrs = d.crs_score;
                if (d.crs_score < lowestCrs) lowestCrs = d.crs_score;
            });
            predictedCutoff = Math.round(sum / generalDraws.length);
        }

        draws.forEach(d => {
            const itas = parseInt(String(d.itas).replace(/,/g, '')) || 0;
            totalItas += itas;
        });
    } else {
        highestCrs = 524;
        lowestCrs = 518;
        totalItas = 14350;
    }

    // Update display
    document.getElementById('predictedCutoff').textContent = predictedCutoff;
    document.getElementById('avgCrsDisplay').textContent = predictedCutoff;
    document.getElementById('highestCrs').textContent = highestCrs;
    document.getElementById('lowestCrs').textContent = lowestCrs;

    const avgItas = draws.length > 0 ? Math.round(totalItas / draws.length) : 2870;
    document.getElementById('predictedItas').textContent = avgItas.toLocaleString();
    document.getElementById('avgItas').textContent = avgItas.toLocaleString();
    document.getElementById('monthlyItas').textContent = '~' + (avgItas * 4).toLocaleString();

    // Calculate next draw date
    const today = new Date();
    const nextDraw = new Date(today);
    nextDraw.setDate(today.getDate() + 7);
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    document.getElementById('predictedDate').textContent = months[nextDraw.getMonth()] + ' ' + nextDraw.getDate();
}

function checkScore() {
    const scoreInput = document.getElementById('userScore');
    const score = parseInt(scoreInput.value);

    if (!score || score < 0 || score > 1200) {
        alert('Please enter a valid CRS score between 0 and 1200');
        return;
    }

    const predictedCutoff = parseInt(document.getElementById('predictedCutoff').textContent);
    const diff = score - predictedCutoff;

    // Calculate chance
    let chance, status, title, description, icon, categories;

    if (score >= predictedCutoff + 30) {
        chance = 95;
        status = 'excellent';
        title = 'Excellent Chances!';
        description = 'Your score is well above the predicted cutoff. You should receive an ITA in upcoming draws.';
        icon = 'bi-check-circle-fill';
        categories = 5;
    } else if (score >= predictedCutoff) {
        chance = 75;
        status = 'good';
        title = 'Good Chances!';
        description = 'Your score meets the predicted cutoff. Strong likelihood of receiving an ITA.';
        icon = 'bi-emoji-smile-fill';
        categories = 4;
    } else if (score >= predictedCutoff - 30) {
        chance = 40;
        status = 'moderate';
        title = 'Moderate Chances';
        description = 'Your score is below the general cutoff. Consider category-based draws or score improvement.';
        icon = 'bi-exclamation-circle-fill';
        categories = 3;
    } else if (score >= 400) {
        chance = 15;
        status = 'low';
        title = 'Lower Chances';
        description = 'Focus on category-based draws if eligible, or consider PNP for guaranteed ITA (+600 points).';
        icon = 'bi-arrow-up-circle-fill';
        categories = 2;
    } else {
        chance = 5;
        status = 'low';
        title = 'Score Improvement Needed';
        description = 'Significant score improvement needed. Consider language tests, education, or Canadian experience.';
        icon = 'bi-arrow-up-circle-fill';
        categories = 1;
    }

    // Update result display
    const resultDiv = document.getElementById('checkResult');
    const resultIcon = document.getElementById('resultIcon');
    const resultTitle = document.getElementById('resultTitle');
    const resultDesc = document.getElementById('resultDescription');

    resultIcon.className = 'result-icon ' + status;
    resultIcon.innerHTML = '<i class="bi ' + icon + '"></i>';
    resultTitle.textContent = title;
    resultDesc.textContent = description;

    document.getElementById('resultChance').textContent = chance + '%';
    document.getElementById('resultDiff').textContent = (diff >= 0 ? '+' : '') + diff;
    document.getElementById('resultCategories').textContent = categories;

    resultDiv.classList.add('show');
}
</script>
{% endblock %}
