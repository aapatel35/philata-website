{% extends "base.html" %}

{% block title %}CRS Score Prediction - Express Entry Forecast{% endblock %}

{% block extra_css %}
<style>
    .page-header-prediction {
        margin-bottom: 32px;
    }

    .page-header-prediction .page-title {
        font-family: 'Plus Jakarta Sans', var(--font-family);
        font-size: 32px;
        font-weight: 800;
        color: var(--text);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 14px;
    }

    .page-header-prediction .page-title i {
        font-size: 28px;
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .page-subtitle {
        color: var(--text-muted);
        font-size: 1rem;
    }

    /* Next Draw Prediction Card */
    .next-draw-card {
        background: linear-gradient(135deg, #1E3A5F 0%, #0891B2 100%);
        border-radius: 24px;
        padding: 2.5rem;
        color: white;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }

    .next-draw-card::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 60%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    }

    .next-draw-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 1.5rem;
        position: relative;
        z-index: 1;
    }

    .next-draw-header i {
        font-size: 2rem;
        opacity: 0.9;
    }

    .next-draw-header h2 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
    }

    .next-draw-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 1.5rem;
        position: relative;
        z-index: 1;
    }

    .draw-stat {
        text-align: center;
        padding: 1.5rem 1rem;
        background: rgba(255,255,255,0.1);
        border-radius: 16px;
        backdrop-filter: blur(10px);
    }

    .draw-stat-value {
        font-size: 2rem;
        font-weight: 800;
        line-height: 1;
        margin-bottom: 0.5rem;
    }

    .draw-stat-label {
        font-size: 0.8rem;
        opacity: 0.9;
    }

    /* Prediction Details Grid */
    .prediction-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .prediction-card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 1.5rem;
    }

    .prediction-card-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border);
    }

    .prediction-card-header i {
        font-size: 1.25rem;
        color: var(--primary);
    }

    .prediction-card-header h3 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text);
    }

    .prediction-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--border);
    }

    .prediction-item:last-child {
        border-bottom: none;
    }

    .prediction-item-label {
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    .prediction-item-value {
        font-weight: 600;
        color: var(--text);
    }

    .prediction-item-value.highlight {
        color: var(--primary);
        font-size: 1.1rem;
    }

    /* Category Predictions */
    .category-predictions {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .category-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 1.5rem;
    }

    .category-header i {
        font-size: 1.5rem;
        color: var(--accent);
    }

    .category-header h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text);
    }

    .category-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .category-item {
        background: var(--bg);
        border-radius: 12px;
        padding: 1.25rem;
        text-align: center;
        border: 1px solid var(--border);
    }

    .category-name {
        font-weight: 600;
        color: var(--text);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .category-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
    }

    .category-badge.likely {
        background: rgba(16, 185, 129, 0.15);
        color: #059669;
    }

    .category-badge.possible {
        background: rgba(245, 158, 11, 0.15);
        color: #D97706;
    }

    .category-score {
        font-size: 1.75rem;
        font-weight: 800;
        color: var(--primary);
        margin-bottom: 0.25rem;
    }

    .category-label {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    /* Recent Draws Table */
    .draws-section {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        overflow: hidden;
        margin-bottom: 2rem;
    }

    .draws-header {
        background: var(--bg);
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .draws-header i {
        font-size: 1.25rem;
        color: var(--accent);
    }

    .draws-header h3 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text);
    }

    .data-timestamp {
        margin-left: auto;
        font-size: 0.75rem;
        color: var(--text-muted);
        background: var(--card);
        padding: 4px 10px;
        border-radius: 6px;
        border: 1px solid var(--border);
    }
    .data-timestamp a {
        color: var(--primary);
        text-decoration: none;
    }
    .data-timestamp a:hover {
        text-decoration: underline;
    }

    .draws-table {
        width: 100%;
    }

    .draw-row {
        display: grid;
        grid-template-columns: 1.2fr 1fr 0.8fr 0.8fr;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border);
        align-items: center;
    }

    .draw-row:last-child {
        border-bottom: none;
    }

    .draw-row.header {
        background: var(--bg);
        font-weight: 600;
        color: var(--text-muted);
        font-size: 0.8rem;
        text-transform: uppercase;
    }

    .draw-row:not(.header):hover {
        background: rgba(30, 58, 138, 0.03);
    }

    .draw-crs {
        font-weight: 700;
        font-size: 1.1rem;
        color: var(--primary);
    }

    .draw-category-badge {
        display: inline-flex;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .draw-category-badge.general {
        background: rgba(99, 102, 241, 0.15);
        color: #6366F1;
    }

    .draw-category-badge.healthcare {
        background: rgba(16, 185, 129, 0.15);
        color: #059669;
    }

    .draw-category-badge.french {
        background: rgba(59, 130, 246, 0.15);
        color: #3B82F6;
    }

    .draw-category-badge.stem {
        background: rgba(168, 85, 247, 0.15);
        color: #A855F7;
    }

    .draw-category-badge.trade {
        background: rgba(245, 158, 11, 0.15);
        color: #D97706;
    }

    .draw-category-badge.cec {
        background: rgba(34, 197, 94, 0.15);
        color: #16A34A;
    }

    .draw-category-badge.pnp {
        background: rgba(236, 72, 153, 0.15);
        color: #DB2777;
    }

    /* Reasoning Section */
    .reasoning-section {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .reasoning-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 1.5rem;
    }

    .reasoning-header i {
        font-size: 1.5rem;
        color: var(--primary);
    }

    .reasoning-header h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text);
    }

    .reasoning-item {
        padding: 1rem;
        background: var(--bg);
        border-radius: 12px;
        margin-bottom: 1rem;
        border-left: 4px solid var(--primary);
    }

    .reasoning-item:last-child {
        margin-bottom: 0;
    }

    .reasoning-title {
        font-weight: 600;
        color: var(--text);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .reasoning-title i {
        color: var(--primary);
        font-size: 1rem;
    }

    .reasoning-text {
        color: var(--text-muted);
        font-size: 0.9rem;
        line-height: 1.6;
    }

    /* Analysis Report Section */
    .analysis-report {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .analysis-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border);
    }

    .analysis-header i {
        font-size: 1.5rem;
        color: var(--accent);
    }

    .analysis-header h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text);
    }

    .analysis-header .live-badge {
        background: #10B981;
        color: white;
        font-size: 0.7rem;
        padding: 4px 10px;
        border-radius: 20px;
        font-weight: 600;
        margin-left: auto;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .analysis-header .live-badge::before {
        content: '';
        width: 6px;
        height: 6px;
        background: white;
        border-radius: 50%;
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .prediction-summary {
        background: linear-gradient(135deg, rgba(30, 58, 138, 0.08), rgba(8, 145, 178, 0.08));
        border: 1px solid rgba(30, 58, 138, 0.2);
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
    }

    .prediction-summary-title {
        font-weight: 700;
        font-size: 1.1rem;
        color: var(--text);
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .prediction-summary-title i {
        color: var(--primary);
    }

    .prediction-summary-text {
        color: var(--text);
        line-height: 1.7;
        font-size: 0.95rem;
    }

    .prediction-summary-text strong {
        color: var(--primary);
    }

    .analysis-factors {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .factor-card {
        background: var(--bg);
        border-radius: 12px;
        padding: 1rem;
        border-left: 4px solid var(--primary);
    }

    .factor-card.positive {
        border-left-color: #10B981;
    }

    .factor-card.negative {
        border-left-color: #EF4444;
    }

    .factor-card.neutral {
        border-left-color: #F59E0B;
    }

    .factor-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 0.5rem;
    }

    .factor-header i {
        font-size: 1rem;
    }

    .factor-card.positive .factor-header i { color: #10B981; }
    .factor-card.negative .factor-header i { color: #EF4444; }
    .factor-card.neutral .factor-header i { color: #F59E0B; }

    .factor-title {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--text);
    }

    .factor-text {
        color: var(--text-muted);
        font-size: 0.85rem;
        line-height: 1.5;
    }

    .draw-pattern-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }

    .draw-pattern-table th,
    .draw-pattern-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid var(--border);
    }

    .draw-pattern-table th {
        background: var(--bg);
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        color: var(--text-muted);
    }

    .draw-pattern-table td {
        font-size: 0.9rem;
    }

    .confidence-meter {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border);
    }

    .confidence-label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .confidence-label span {
        font-weight: 600;
        color: var(--text);
    }

    .confidence-value {
        font-weight: 700;
        color: var(--primary);
    }

    .confidence-bar {
        height: 10px;
        background: var(--bg);
        border-radius: 5px;
        overflow: hidden;
    }

    .confidence-fill {
        height: 100%;
        background: linear-gradient(90deg, #10B981, #0891B2);
        border-radius: 5px;
        transition: width 0.5s ease;
    }

    .data-source {
        margin-top: 1rem;
        padding: 0.75rem;
        background: var(--bg);
        border-radius: 8px;
        font-size: 0.8rem;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .data-source i {
        color: var(--primary);
    }

    .data-source a {
        color: var(--primary);
        text-decoration: none;
    }

    .data-source a:hover {
        text-decoration: underline;
    }

    /* Score Check Section */
    .score-check-section {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
        border: 1px solid rgba(99, 102, 241, 0.3);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        text-align: center;
    }

    .score-check-section h3 {
        margin: 0 0 1rem 0;
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text);
    }

    .score-check-section p {
        color: var(--text-muted);
        margin-bottom: 1.5rem;
    }

    .score-check-form {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
    }

    .score-input {
        padding: 0.875rem 1.25rem;
        font-size: 1.25rem;
        font-weight: 600;
        text-align: center;
        background: var(--card);
        border: 2px solid var(--border);
        border-radius: 12px;
        color: var(--text);
        width: 150px;
    }

    .score-input:focus {
        outline: none;
        border-color: var(--primary);
    }

    .check-btn {
        padding: 0.875rem 2rem;
        font-size: 1rem;
        font-weight: 600;
        background: linear-gradient(135deg, #1E3A5F 0%, #0891B2 100%);
        color: #FFFFFF;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .check-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(30, 58, 95, 0.3);
        background: linear-gradient(135deg, #1a3352 0%, #0780a0 100%);
    }

    /* Check Result */
    .check-result {
        display: none;
        margin-top: 1.5rem;
        padding: 1.5rem;
        background: var(--card);
        border-radius: 12px;
        text-align: left;
    }

    .check-result.show {
        display: block;
    }

    .result-status {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 1rem;
    }

    .result-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .result-icon.excellent {
        background: rgba(16, 185, 129, 0.15);
        color: #059669;
    }

    .result-icon.good {
        background: rgba(52, 211, 153, 0.15);
        color: #10B981;
    }

    .result-icon.moderate {
        background: rgba(245, 158, 11, 0.15);
        color: #D97706;
    }

    .result-icon.low {
        background: rgba(239, 68, 68, 0.15);
        color: #DC2626;
    }

    .result-text h4 {
        margin: 0 0 4px 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text);
    }

    .result-text p {
        margin: 0;
        font-size: 0.9rem;
        color: var(--text-muted);
    }

    .result-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border);
    }

    .result-detail {
        text-align: center;
    }

    .result-detail-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary);
    }

    .result-detail-label {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    /* Disclaimer */
    .disclaimer-box {
        background: rgba(245, 158, 11, 0.1);
        border: 1px solid rgba(245, 158, 11, 0.3);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        font-size: 0.9rem;
        color: var(--text);
    }

    .disclaimer-box i {
        color: #D97706;
        margin-right: 8px;
    }

    @media (max-width: 768px) {
        .next-draw-stats {
            grid-template-columns: repeat(2, 1fr);
        }

        .draw-row {
            grid-template-columns: 1fr;
            gap: 0.5rem;
            padding: 1rem;
        }

        .draw-row.header {
            display: none;
        }

        .category-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .score-check-form {
            flex-direction: column;
            align-items: center;
        }

        .score-input, .check-btn {
            width: 100%;
            max-width: 300px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header-prediction">
    <h1 class="page-title">
        <i class="bi bi-graph-up-arrow"></i>
        CRS Score Prediction
    </h1>
    <p class="page-subtitle">AI-powered Express Entry draw predictions based on historical IRCC data and trends</p>
</div>

<!-- Next Draw Prediction Card -->
<div class="next-draw-card">
    <div class="next-draw-header">
        <i class="bi bi-lightning-charge-fill"></i>
        <h2>Next Express Entry Draw Prediction</h2>
    </div>
    <div class="next-draw-stats">
        <div class="draw-stat">
            <div class="draw-stat-value" id="predictedCutoff">{{ avg_crs if avg_crs else 520 }}</div>
            <div class="draw-stat-label">Predicted CRS Cutoff</div>
        </div>
        <div class="draw-stat">
            <div class="draw-stat-value" id="predictedItas">2,800</div>
            <div class="draw-stat-label">Expected ITAs</div>
        </div>
        <div class="draw-stat">
            <div class="draw-stat-value" id="predictedDate">Jan 15</div>
            <div class="draw-stat-label">Expected Date</div>
        </div>
        <div class="draw-stat">
            <div class="draw-stat-value" id="predictedProgram">FSW/CEC</div>
            <div class="draw-stat-label">Target Programs</div>
        </div>
        <div class="draw-stat">
            <div class="draw-stat-value" id="predictedCategory">General</div>
            <div class="draw-stat-label">Draw Category</div>
        </div>
        <div class="draw-stat">
            <div class="draw-stat-value" id="drawFrequency">Bi-weekly</div>
            <div class="draw-stat-label">Draw Frequency</div>
        </div>
    </div>
</div>

<!-- Prediction Details Grid -->
<div class="prediction-grid">
    <div class="prediction-card">
        <div class="prediction-card-header">
            <i class="bi bi-bar-chart-fill"></i>
            <h3>General Draw Analysis</h3>
        </div>
        <div class="prediction-item">
            <span class="prediction-item-label">Average CRS (Last 5 Draws)</span>
            <span class="prediction-item-value highlight" id="avgCrsDisplay">{{ avg_crs if avg_crs else 520 }}</span>
        </div>
        <div class="prediction-item">
            <span class="prediction-item-label">Highest Recent CRS</span>
            <span class="prediction-item-value" id="highestCrs">711</span>
        </div>
        <div class="prediction-item">
            <span class="prediction-item-label">Lowest Recent CRS</span>
            <span class="prediction-item-value" id="lowestCrs">518</span>
        </div>
        <div class="prediction-item">
            <span class="prediction-item-label">CRS Trend</span>
            <span class="prediction-item-value" style="color: #059669;">Stable</span>
        </div>
    </div>

    <div class="prediction-card">
        <div class="prediction-card-header">
            <i class="bi bi-people-fill"></i>
            <h3>ITA Distribution</h3>
        </div>
        <div class="prediction-item">
            <span class="prediction-item-label">Average ITAs per Draw</span>
            <span class="prediction-item-value highlight" id="avgItas">2,870</span>
        </div>
        <div class="prediction-item">
            <span class="prediction-item-label">Total ITAs (Last Month)</span>
            <span class="prediction-item-value" id="monthlyItas">~11,500</span>
        </div>
        <div class="prediction-item">
            <span class="prediction-item-label">2026 Target</span>
            <span class="prediction-item-value">110,770</span>
        </div>
        <div class="prediction-item">
            <span class="prediction-item-label">Pool Size (Est.)</span>
            <span class="prediction-item-value">~200,000</span>
        </div>
    </div>
</div>

<!-- Category-Based Draw Predictions -->
<div class="category-predictions">
    <div class="category-header">
        <i class="bi bi-diagram-3-fill"></i>
        <h3>Category-Based Draw Predictions</h3>
    </div>
    <div class="category-grid">
        <div class="category-item">
            <div class="category-name">
                General
                <span class="category-badge likely">Likely Next</span>
            </div>
            <div class="category-score">520</div>
            <div class="category-label">Predicted Cutoff</div>
        </div>
        <div class="category-item">
            <div class="category-name">
                Healthcare
                <span class="category-badge possible">Possible</span>
            </div>
            <div class="category-score">430</div>
            <div class="category-label">Predicted Cutoff</div>
        </div>
        <div class="category-item">
            <div class="category-name">
                STEM
                <span class="category-badge possible">Possible</span>
            </div>
            <div class="category-score">480</div>
            <div class="category-label">Predicted Cutoff</div>
        </div>
        <div class="category-item">
            <div class="category-name">
                French Proficiency
                <span class="category-badge possible">Possible</span>
            </div>
            <div class="category-score">380</div>
            <div class="category-label">Predicted Cutoff</div>
        </div>
        <div class="category-item">
            <div class="category-name">
                Trade Occupations
                <span class="category-badge possible">Possible</span>
            </div>
            <div class="category-score">420</div>
            <div class="category-label">Predicted Cutoff</div>
        </div>
        <div class="category-item">
            <div class="category-name">
                Transport
                <span class="category-badge possible">Possible</span>
            </div>
            <div class="category-score">440</div>
            <div class="category-label">Predicted Cutoff</div>
        </div>
    </div>
</div>

<!-- Check Your Score Section -->
<div class="score-check-section">
    <h3><i class="bi bi-person-check me-2"></i>Check Your ITA Chances</h3>
    <p>Enter your CRS score to see if you would qualify for the predicted draws</p>
    <div class="score-check-form">
        <input type="number" id="userScore" class="score-input" placeholder="Your CRS" min="0" max="1200">
        <button class="check-btn" onclick="checkScore()">
            <i class="bi bi-search"></i>
            Check Chances
        </button>
    </div>
    <div class="check-result" id="checkResult">
        <div class="result-status">
            <div class="result-icon" id="resultIcon">
                <i class="bi bi-check-circle-fill"></i>
            </div>
            <div class="result-text">
                <h4 id="resultTitle">Excellent Chances!</h4>
                <p id="resultDescription">Your score is above the predicted cutoff.</p>
            </div>
        </div>
        <div class="result-details">
            <div class="result-detail">
                <div class="result-detail-value" id="resultChance">95%</div>
                <div class="result-detail-label">ITA Probability</div>
            </div>
            <div class="result-detail">
                <div class="result-detail-value" id="resultDiff">+30</div>
                <div class="result-detail-label">Points Above Cutoff</div>
            </div>
            <div class="result-detail">
                <div class="result-detail-value" id="resultCategories">3</div>
                <div class="result-detail-label">Categories Eligible</div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Draws History -->
<div class="draws-section">
    <div class="draws-header">
        <i class="bi bi-clock-history"></i>
        <h3>Recent Express Entry Draws</h3>
        <span class="data-timestamp">Last updated: Jan 12, 2026 | Source: <a href="https://www.canada.ca/en/immigration-refugees-citizenship/corporate/mandate/policies-operational-instructions-agreements/ministerial-instructions/express-entry-rounds.html" target="_blank" rel="noopener">Official IRCC</a></span>
    </div>
    <div class="draws-table">
        <div class="draw-row header">
            <span>Date</span>
            <span>Category</span>
            <span>CRS Cutoff</span>
            <span>ITAs Issued</span>
        </div>
        {% if draws %}
            {% for draw in draws %}
            <div class="draw-row">
                <span>{{ draw.date }}</span>
                <span>
                    <span class="draw-category-badge {% if 'general' in draw.category|lower or draw.category == 'No program specified' %}general{% elif 'health' in draw.category|lower %}healthcare{% elif 'french' in draw.category|lower %}french{% elif 'stem' in draw.category|lower %}stem{% elif 'trade' in draw.category|lower %}trade{% else %}general{% endif %}">
                        {{ draw.category if draw.category != 'No program specified' else 'General' }}
                    </span>
                </span>
                <span class="draw-crs">{{ draw.crs_score }}</span>
                <span>{{ draw.itas }}</span>
            </div>
            {% endfor %}
        {% else %}
            <!-- Official IRCC Draw Data - Last updated: Jan 12, 2026 -->
            <div class="draw-row">
                <span>Jan 7, 2026</span>
                <span><span class="draw-category-badge cec">CEC</span></span>
                <span class="draw-crs">511</span>
                <span>8,000</span>
            </div>
            <div class="draw-row">
                <span>Jan 5, 2026</span>
                <span><span class="draw-category-badge pnp">PNP</span></span>
                <span class="draw-crs">711</span>
                <span>574</span>
            </div>
            <div class="draw-row">
                <span>Dec 17, 2025</span>
                <span><span class="draw-category-badge french">French</span></span>
                <span class="draw-crs">399</span>
                <span>6,000</span>
            </div>
            <div class="draw-row">
                <span>Dec 16, 2025</span>
                <span><span class="draw-category-badge cec">CEC</span></span>
                <span class="draw-crs">515</span>
                <span>5,000</span>
            </div>
            <div class="draw-row">
                <span>Dec 11, 2025</span>
                <span><span class="draw-category-badge healthcare">Healthcare</span></span>
                <span class="draw-crs">476</span>
                <span>1,000</span>
            </div>
        {% endif %}
    </div>
</div>

<!-- Detailed Analysis Report -->
<div class="analysis-report">
    <div class="analysis-header">
        <i class="bi bi-file-earmark-text-fill"></i>
        <h3>Next Draw Prediction Report</h3>
        <span class="live-badge">LIVE DATA</span>
    </div>

    <div class="prediction-summary">
        <div class="prediction-summary-title">
            <i class="bi bi-bullseye"></i>
            Prediction Summary
        </div>
        <div class="prediction-summary-text" id="predictionSummaryText">
            Based on analysis of the last <strong>20 Express Entry draws</strong> from official IRCC data, we predict the next draw will be a <strong id="nextDrawType">Canadian Experience Class (CEC)</strong> draw with an estimated CRS cutoff of <strong id="nextCrsPrediction">515-520</strong> points. IRCC has been conducting <strong id="drawFrequency">2-3 draws per week</strong>, alternating between CEC, PNP, and category-based draws. The next draw is expected around <strong id="nextDrawDateText">January 14-15, 2026</strong>.
        </div>
    </div>

    <h4 style="margin-bottom: 1rem; color: var(--text);">Key Factors Affecting Our Prediction</h4>

    <div class="analysis-factors" id="analysisFactors">
        <div class="factor-card positive">
            <div class="factor-header">
                <i class="bi bi-graph-down-arrow"></i>
                <span class="factor-title">Lower CEC Cutoffs in 2026</span>
            </div>
            <div class="factor-text" id="factor1Text">
                The Jan 7 CEC draw had a cutoff of 511, the lowest since September 2024. This suggests IRCC is prioritizing in-Canada candidates with lower barriers.
            </div>
        </div>

        <div class="factor-card neutral">
            <div class="factor-header">
                <i class="bi bi-calendar3"></i>
                <span class="factor-title">Draw Frequency Pattern</span>
            </div>
            <div class="factor-text" id="factor2Text">
                IRCC is conducting draws every 1-2 days, rotating between CEC, PNP, and French/Healthcare categories. Expect continued high-frequency draws.
            </div>
        </div>

        <div class="factor-card positive">
            <div class="factor-header">
                <i class="bi bi-people-fill"></i>
                <span class="factor-title">Large ITA Volumes</span>
            </div>
            <div class="factor-text" id="factor3Text">
                Recent CEC draws issued 5,000-8,000 ITAs each. High volumes benefit candidates with scores in the 500-520 range.
            </div>
        </div>

        <div class="factor-card negative">
            <div class="factor-header">
                <i class="bi bi-arrow-down-circle"></i>
                <span class="factor-title">Reduced 2026 Targets</span>
            </div>
            <div class="factor-text" id="factor4Text">
                Express Entry target for 2026 is 109,000 (down 12% from 2025). Fewer total ITAs may lead to more selective draws later in the year.
            </div>
        </div>
    </div>

    <h4 style="margin-bottom: 1rem; color: var(--text);">Recent Draw Pattern Analysis</h4>

    <table class="draw-pattern-table">
        <thead>
            <tr>
                <th>Category</th>
                <th>Last CRS</th>
                <th>Last ITAs</th>
                <th>Frequency</th>
                <th>Next Expected</th>
            </tr>
        </thead>
        <tbody id="drawPatternBody">
            <tr>
                <td><strong>CEC</strong></td>
                <td id="cecLastCrs">511</td>
                <td id="cecLastItas">8,000</td>
                <td>Every 3-5 days</td>
                <td id="cecNextExpected">Jan 12-14</td>
            </tr>
            <tr>
                <td><strong>PNP</strong></td>
                <td id="pnpLastCrs">711</td>
                <td id="pnpLastItas">574</td>
                <td>Every 3-5 days</td>
                <td id="pnpNextExpected">Jan 10-12</td>
            </tr>
            <tr>
                <td><strong>French</strong></td>
                <td id="frenchLastCrs">399</td>
                <td id="frenchLastItas">6,000</td>
                <td>Every 2-3 weeks</td>
                <td id="frenchNextExpected">Jan 14-21</td>
            </tr>
            <tr>
                <td><strong>Healthcare</strong></td>
                <td id="healthLastCrs">476</td>
                <td id="healthLastItas">1,000</td>
                <td>Every 2-4 weeks</td>
                <td id="healthNextExpected">Jan 8-15</td>
            </tr>
        </tbody>
    </table>

    <div class="confidence-meter">
        <div class="confidence-label">
            <span>Prediction Confidence</span>
            <span class="confidence-value" id="confidencePercent">78%</span>
        </div>
        <div class="confidence-bar">
            <div class="confidence-fill" id="confidenceFill" style="width: 78%"></div>
        </div>
    </div>

    <div class="data-source">
        <i class="bi bi-shield-check"></i>
        <span>Data source: <a href="https://www.canada.ca/en/immigration-refugees-citizenship/services/immigrate-canada/express-entry/submit-profile/rounds-invitations.html" target="_blank">Official IRCC Express Entry Rounds</a> - Updated in real-time</span>
    </div>
</div>

<!-- Reasoning Section -->
<div class="reasoning-section">
    <div class="reasoning-header">
        <i class="bi bi-lightbulb-fill"></i>
        <h3>Prediction Methodology</h3>
    </div>

    <div class="reasoning-item">
        <div class="reasoning-title">
            <i class="bi bi-database-check"></i>
            Official Data Source
        </div>
        <div class="reasoning-text">
            All predictions are based on official IRCC data from <strong>canada.ca</strong>. Our draw information is sourced directly from IRCC's official Express Entry rounds page, ensuring accuracy and timely updates.
        </div>
    </div>

    <div class="reasoning-item">
        <div class="reasoning-title">
            <i class="bi bi-graph-up"></i>
            Historical Pattern Analysis
        </div>
        <div class="reasoning-text">
            We analyze the last 20+ draws to identify patterns in CRS cutoffs, ITA volumes, and draw frequency. Category-specific trends (CEC, PNP, French, Healthcare, STEM, Trade) are tracked separately for more accurate predictions.
        </div>
    </div>

    <div class="reasoning-item">
        <div class="reasoning-title">
            <i class="bi bi-calculator"></i>
            Statistical Modeling
        </div>
        <div class="reasoning-text">
            Predictions factor in: average CRS by category, ITA volume trends, draw frequency, seasonal patterns, and IRCC's Immigration Levels Plan targets. Confidence levels adjust based on data consistency and recent volatility.
        </div>
    </div>

    <div class="reasoning-item">
        <div class="reasoning-title">
            <i class="bi bi-flag"></i>
            Immigration Levels Plan 2026
        </div>
        <div class="reasoning-text">
            Canada's 2026 Express Entry target is 109,000 permanent residents. IRCC has allocated 33,000 spots specifically for in-Canada applicants (CEC pathway). This influences our CEC-focused predictions and lower cutoff expectations.
        </div>
    </div>
</div>

<!-- Official Sources Section -->
<div class="reasoning-section">
    <div class="reasoning-header">
        <i class="bi bi-shield-check"></i>
        <h3>Official Data Sources</h3>
    </div>

    <div class="reasoning-item">
        <div class="reasoning-title">
            <i class="bi bi-building"></i>
            Federal Government Sources
        </div>
        <div class="reasoning-text">
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                <li><a href="https://www.canada.ca/en/immigration-refugees-citizenship/services/immigrate-canada/express-entry/submit-profile/rounds-invitations.html" target="_blank" style="color: var(--primary);">IRCC Express Entry Rounds</a> - Official draw history</li>
                <li><a href="https://www.canada.ca/en/immigration-refugees-citizenship/services/application/check-processing-times.html" target="_blank" style="color: var(--primary);">IRCC Processing Times</a> - Official processing times</li>
                <li><a href="https://www.canada.ca/en/immigration-refugees-citizenship/news/notices/supplementary-immigration-levels-2025-2027.html" target="_blank" style="color: var(--primary);">Immigration Levels Plan 2025-2027</a> - Annual targets</li>
            </ul>
        </div>
    </div>

    <div class="reasoning-item">
        <div class="reasoning-title">
            <i class="bi bi-geo-alt"></i>
            Provincial Nominee Program (PNP) Sources
        </div>
        <div class="reasoning-text">
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem; columns: 2; column-gap: 2rem;">
                <li><a href="https://www.ontario.ca/page/ontario-immigrant-nominee-program-oinp" target="_blank" style="color: var(--primary);">Ontario OINP</a></li>
                <li><a href="https://www.welcomebc.ca/Immigrate-to-B-C/BC-PNP-Skills-Immigration" target="_blank" style="color: var(--primary);">BC PNP</a></li>
                <li><a href="https://www.alberta.ca/alberta-advantage-immigration-program" target="_blank" style="color: var(--primary);">Alberta AAIP</a></li>
                <li><a href="https://www.saskatchewan.ca/residents/moving-to-saskatchewan/immigrating-to-saskatchewan/saskatchewan-immigrant-nominee-program" target="_blank" style="color: var(--primary);">Saskatchewan SINP</a></li>
                <li><a href="https://immigratemanitoba.com/" target="_blank" style="color: var(--primary);">Manitoba MPNP</a></li>
                <li><a href="https://novascotiaimmigration.com/move-here/" target="_blank" style="color: var(--primary);">Nova Scotia NSNP</a></li>
                <li><a href="https://www.welcomenb.ca/content/wel-bien/en/immigrating/content/HowToImmigrate/NBProvincialNomineeProgram.html" target="_blank" style="color: var(--primary);">New Brunswick NBPNP</a></li>
                <li><a href="https://www.princeedwardisland.ca/en/topic/office-immigration" target="_blank" style="color: var(--primary);">PEI PNP</a></li>
                <li><a href="https://www.gov.nl.ca/immigration/immigrating-to-newfoundland-and-labrador/provincial-nominee-program/" target="_blank" style="color: var(--primary);">Newfoundland & Labrador NLPNP</a></li>
                <li><a href="https://www.immigratenwt.ca/en/northwest-territories-nominee-program" target="_blank" style="color: var(--primary);">Northwest Territories NTNP</a></li>
                <li><a href="https://yukon.ca/en/doing-business/business-supports-and-financing/yukon-nominee-program" target="_blank" style="color: var(--primary);">Yukon YNP</a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Disclaimer -->
<div class="disclaimer-box">
    <i class="bi bi-exclamation-triangle-fill"></i>
    <strong>Disclaimer:</strong> Predictions are based on historical data and statistical analysis. Actual draw results may vary significantly. IRCC determines all Express Entry draw parameters. This tool is for informational purposes only and should not be relied upon for immigration decisions.
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize data
const draws = {{ draws | tojson | safe if draws else '[]' }};
const avgCrs = {{ avg_crs if avg_crs else 520 }};

// Calculate and display predictions on page load
document.addEventListener('DOMContentLoaded', function() {
    initializePredictions();
});

function initializePredictions() {
    // Calculate predicted cutoff from draws
    let predictedCutoff = avgCrs;
    let highestCrs = 0;
    let lowestCrs = 999;
    let totalItas = 0;

    // Category-specific data
    let cecDraws = [];
    let pnpDraws = [];
    let frenchDraws = [];
    let healthDraws = [];

    if (draws && draws.length > 0) {
        // Categorize draws
        draws.forEach(d => {
            const category = (d.category || '').toLowerCase();
            if (category.includes('experience')) {
                cecDraws.push(d);
            } else if (category.includes('provincial') || category.includes('pnp')) {
                pnpDraws.push(d);
            } else if (category.includes('french')) {
                frenchDraws.push(d);
            } else if (category.includes('health')) {
                healthDraws.push(d);
            }
        });

        // Calculate CEC stats (primary prediction focus)
        if (cecDraws.length > 0) {
            let sum = 0;
            cecDraws.forEach(d => {
                sum += d.crs_score;
                if (d.crs_score > highestCrs) highestCrs = d.crs_score;
                if (d.crs_score < lowestCrs) lowestCrs = d.crs_score;
            });
            predictedCutoff = Math.round(sum / cecDraws.length);
        }

        draws.forEach(d => {
            const itas = parseInt(String(d.itas).replace(/,/g, '')) || 0;
            totalItas += itas;
        });
    } else {
        highestCrs = 531;
        lowestCrs = 511;
        totalItas = 50000;
    }

    // Update display
    document.getElementById('predictedCutoff').textContent = predictedCutoff;
    document.getElementById('avgCrsDisplay').textContent = predictedCutoff;
    document.getElementById('highestCrs').textContent = highestCrs;
    document.getElementById('lowestCrs').textContent = lowestCrs;

    const avgItas = draws.length > 0 ? Math.round(totalItas / draws.length) : 3500;
    document.getElementById('predictedItas').textContent = avgItas.toLocaleString();
    document.getElementById('avgItas').textContent = avgItas.toLocaleString();
    document.getElementById('monthlyItas').textContent = '~' + (avgItas * 8).toLocaleString();

    // Calculate next draw date
    const today = new Date();
    const nextDraw = new Date(today);
    nextDraw.setDate(today.getDate() + 2); // IRCC draws every 1-2 days now
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    document.getElementById('predictedDate').textContent = months[nextDraw.getMonth()] + ' ' + nextDraw.getDate();

    // Update detailed analysis report
    updateAnalysisReport(cecDraws, pnpDraws, frenchDraws, healthDraws, predictedCutoff);
}

function updateAnalysisReport(cecDraws, pnpDraws, frenchDraws, healthDraws, predictedCutoff) {
    const today = new Date();
    const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

    // Determine next likely draw type based on pattern
    let nextDrawType = 'Canadian Experience Class (CEC)';
    let nextCrsPrediction = (predictedCutoff - 5) + '-' + (predictedCutoff + 5);

    // Get latest draw info for each category
    const latestCec = cecDraws[0] || { crs_score: 511, itas: '8,000', date: 'Jan 7, 2026' };
    const latestPnp = pnpDraws[0] || { crs_score: 711, itas: '574', date: 'Jan 5, 2026' };
    const latestFrench = frenchDraws[0] || { crs_score: 399, itas: '6,000', date: 'Dec 17, 2025' };
    const latestHealth = healthDraws[0] || { crs_score: 476, itas: '1,000', date: 'Dec 11, 2025' };

    // Calculate next expected dates (based on frequency patterns)
    const nextDate = new Date(today);
    nextDate.setDate(today.getDate() + 2);
    const nextDateStr = months[nextDate.getMonth()] + ' ' + nextDate.getDate() + '-' + (nextDate.getDate() + 2);

    // Update summary text
    const summaryEl = document.getElementById('predictionSummaryText');
    if (summaryEl) {
        summaryEl.innerHTML = `Based on analysis of the last <strong>${draws.length} Express Entry draws</strong> from official IRCC data, we predict the next draw will be a <strong>${nextDrawType}</strong> draw with an estimated CRS cutoff of <strong>${nextCrsPrediction}</strong> points. IRCC has been conducting <strong>2-3 draws per week</strong>, alternating between CEC, PNP, and category-based draws. The next draw is expected around <strong>${nextDateStr}, 2026</strong>.`;
    }

    // Update pattern table
    if (document.getElementById('cecLastCrs')) {
        document.getElementById('cecLastCrs').textContent = latestCec.crs_score;
        document.getElementById('cecLastItas').textContent = latestCec.itas;

        document.getElementById('pnpLastCrs').textContent = latestPnp.crs_score;
        document.getElementById('pnpLastItas').textContent = latestPnp.itas;

        document.getElementById('frenchLastCrs').textContent = latestFrench.crs_score;
        document.getElementById('frenchLastItas').textContent = latestFrench.itas;

        document.getElementById('healthLastCrs').textContent = latestHealth.crs_score;
        document.getElementById('healthLastItas').textContent = latestHealth.itas;
    }

    // Update factor text based on actual data
    if (document.getElementById('factor1Text') && cecDraws.length > 0) {
        const lowestCec = Math.min(...cecDraws.map(d => d.crs_score));
        document.getElementById('factor1Text').textContent =
            `The latest CEC draw had a cutoff of ${latestCec.crs_score}, ${lowestCec < 515 ? 'one of the lowest in recent history' : 'following the current trend'}. ${lowestCec < 520 ? 'This suggests IRCC is prioritizing in-Canada candidates with lower barriers.' : 'CEC cutoffs remain stable.'}`;
    }

    if (document.getElementById('factor3Text') && cecDraws.length > 0) {
        const avgCecItas = cecDraws.reduce((sum, d) => sum + parseInt(String(d.itas).replace(/,/g, '')), 0) / cecDraws.length;
        document.getElementById('factor3Text').textContent =
            `Recent CEC draws issued ${Math.round(avgCecItas).toLocaleString()} ITAs on average. ${avgCecItas > 4000 ? 'High volumes benefit candidates with scores in the 500-520 range.' : 'Moderate volumes maintain competitive cutoffs.'}`;
    }

    // Calculate confidence based on data consistency
    let confidence = 75;
    if (cecDraws.length >= 5) {
        const crsValues = cecDraws.slice(0, 5).map(d => d.crs_score);
        const variance = Math.max(...crsValues) - Math.min(...crsValues);
        if (variance < 15) confidence = 85;
        else if (variance < 25) confidence = 78;
        else confidence = 65;
    }

    if (document.getElementById('confidencePercent')) {
        document.getElementById('confidencePercent').textContent = confidence + '%';
        document.getElementById('confidenceFill').style.width = confidence + '%';
    }

    // Update next expected dates based on today's date
    const cecNext = new Date(today); cecNext.setDate(today.getDate() + 3);
    const pnpNext = new Date(today); pnpNext.setDate(today.getDate() + 2);
    const frenchNext = new Date(today); frenchNext.setDate(today.getDate() + 10);
    const healthNext = new Date(today); healthNext.setDate(today.getDate() + 7);

    const shortMonths = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    if (document.getElementById('cecNextExpected')) {
        document.getElementById('cecNextExpected').textContent = shortMonths[cecNext.getMonth()] + ' ' + cecNext.getDate() + '-' + (cecNext.getDate() + 2);
        document.getElementById('pnpNextExpected').textContent = shortMonths[pnpNext.getMonth()] + ' ' + pnpNext.getDate() + '-' + (pnpNext.getDate() + 2);
        document.getElementById('frenchNextExpected').textContent = shortMonths[frenchNext.getMonth()] + ' ' + frenchNext.getDate() + '-' + (frenchNext.getDate() + 7);
        document.getElementById('healthNextExpected').textContent = shortMonths[healthNext.getMonth()] + ' ' + healthNext.getDate() + '-' + (healthNext.getDate() + 7);
    }
}

function checkScore() {
    const scoreInput = document.getElementById('userScore');
    const score = parseInt(scoreInput.value);

    if (!score || score < 0 || score > 1200) {
        alert('Please enter a valid CRS score between 0 and 1200');
        return;
    }

    const predictedCutoff = parseInt(document.getElementById('predictedCutoff').textContent);
    const diff = score - predictedCutoff;

    // Calculate chance
    let chance, status, title, description, icon, categories;

    if (score >= predictedCutoff + 30) {
        chance = 95;
        status = 'excellent';
        title = 'Excellent Chances!';
        description = 'Your score is well above the predicted cutoff. You should receive an ITA in upcoming draws.';
        icon = 'bi-check-circle-fill';
        categories = 5;
    } else if (score >= predictedCutoff) {
        chance = 75;
        status = 'good';
        title = 'Good Chances!';
        description = 'Your score meets the predicted cutoff. Strong likelihood of receiving an ITA.';
        icon = 'bi-emoji-smile-fill';
        categories = 4;
    } else if (score >= predictedCutoff - 30) {
        chance = 40;
        status = 'moderate';
        title = 'Moderate Chances';
        description = 'Your score is below the general cutoff. Consider category-based draws or score improvement.';
        icon = 'bi-exclamation-circle-fill';
        categories = 3;
    } else if (score >= 400) {
        chance = 15;
        status = 'low';
        title = 'Lower Chances';
        description = 'Focus on category-based draws if eligible, or consider PNP for guaranteed ITA (+600 points).';
        icon = 'bi-arrow-up-circle-fill';
        categories = 2;
    } else {
        chance = 5;
        status = 'low';
        title = 'Score Improvement Needed';
        description = 'Significant score improvement needed. Consider language tests, education, or Canadian experience.';
        icon = 'bi-arrow-up-circle-fill';
        categories = 1;
    }

    // Update result display
    const resultDiv = document.getElementById('checkResult');
    const resultIcon = document.getElementById('resultIcon');
    const resultTitle = document.getElementById('resultTitle');
    const resultDesc = document.getElementById('resultDescription');

    resultIcon.className = 'result-icon ' + status;
    resultIcon.innerHTML = '<i class="bi ' + icon + '"></i>';
    resultTitle.textContent = title;
    resultDesc.textContent = description;

    document.getElementById('resultChance').textContent = chance + '%';
    document.getElementById('resultDiff').textContent = (diff >= 0 ? '+' : '') + diff;
    document.getElementById('resultCategories').textContent = categories;

    resultDiv.classList.add('show');
}
</script>
{% endblock %}
